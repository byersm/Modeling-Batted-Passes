---
title: "Examining Batted Passes in the NFL"
author: "Lucca Ferraz, Maggie Byers, Yixin (Amelia) Yuan"
format: 
  revealjs: 
    theme: edtheme2.scss
    slide-number: true
    transition: slide
    embed-resources: true
editor: visual
toc: true
execute:
  echo: false
  warning: false
  message: false
  cache: true

---

# Intro {.smaller}

-   Exploring the factors that go into causing batted passes
    -   Batted pass: defender hits the ball down shortly after QB releases it
    -   Typically results in incomplete pass, no yards gained
-   Initial characters
    -   QB height
    -   Offensive formation
    -   Defense formation
    -   Pass type
    -   Overall related more to defense or offense

# Data {.smaller}

-   Data from nflreadr
    -   Play by play data 2016 through 2023
    -   Player info - QB height
    -   Did not have information on which passes were batted
-   For The Numbers (FTN)
    -   Included tipped and batted passes from 2019 - 2023 seasons
    -   Detailed formation information from 2022 and 2023 seasons

# Methods {.smaller}

-   Focused on explaining variance, not predicting batted passes
-   Multilevel Logistic Model
    -   Random effects - quarterback, defensive team
    -   Fixed effects - QB height, pass location, number of players in backfield, pass rushers

# [Initial data analysis showed no influence from QB height]{.r-text-fit}

```{r}
#| echo: false
#| eval: true
#| message: true
#| warning: false
#| fig-align: "center"

library(tidyverse)
library(readxl)
# install.packages("ggthemes")
library(ggthemes)

#creating dataset
player_data <- nflreadr::load_players()
all_plays2023 <- nflreadr::load_pbp()
batted_passes <- read_excel("/Users/magsb/Desktop/SURE/2019-2023_batted_passes.xlsx")
excel_batted <- batted_passes
excel_batted$is_batted <- 1
excel_simple <- excel_batted |> 
  mutate(across(c("HOME", "AWAY"), ~ str_replace(
    string = .x, pattern = "LAR", replacement = "LA"))) |> 
  select(week = WEEK, home_team = HOME, away_team = AWAY, play_id = `PLAY ID`, is_batted)

all_plays2023 <- left_join(all_plays2023, excel_simple)
all_plays2023$is_batted <- all_plays2023$is_batted |> 
  replace_na(0)
pass_plays2023 <- all_plays2023 |> 
  filter(play_type == "pass")


pass_by_qb <- left_join(pass_plays2023, player_data, by = join_by(passer_player_id == gsis_id)) 

#plotting
pass_by_qb <- pass_by_qb |> 
  group_by(passer_player_name) |>   
  mutate(total_passes = n(), 
            total_batted_passes = sum(is_batted), 
            qb_height = mean(height)) |> 
  filter(total_passes>100)
pass_by_qb |> 
  ggplot(aes(x = qb_height, color = factor(is_batted))) +
  geom_density() +
  theme_clean() +
  theme(legend.position = "bottom") + 
  labs(
    title = "Density Plot of Passes by QB Height", 
    x = "QB Height (inches)", 
    y = "Density", 
    color = "Batted"
  ) 
```






# QB Coefficients {.smaller}

```{r}
#| echo: false
#| eval: true
#| message: true
#| warning: false

library(nflverse)
library(tidyverse)
library(lme4)
library(broom.mixed)
library(Matrix)
#creating dataset
player_data <- nflreadr::load_players()
all_plays2023 <- nflreadr::load_pbp()
batted_passes <- read_excel("/Users/magsb/Desktop/SURE/2019-2023_batted_passes.xlsx")
excel_batted <- batted_passes
excel_batted$is_batted <- 1
excel_simple <- excel_batted |> 
  mutate(across(c("HOME", "AWAY"), ~ str_replace(
   string = .x, pattern = "LAR", replacement = "LA"))) |> 
  select(week = WEEK, home_team = HOME, away_team = AWAY, play_id = `PLAY ID`, is_batted)

ftn_charting <- nflreadr::load_ftn_charting(seasons = c(2022, 2023))
ftn_charting_clean <- ftn_charting |> 
  select(game_id = nflverse_game_id, play_id = nflverse_play_id, 
         starting_hash:n_pass_rushers, -is_qb_sneak)
pass_plays20222023 <- load_pbp(seasons = c(2022, 2023)) |> 
  filter(play_type == "pass")
pass_plays20222023 <- left_join(pass_plays20222023, excel_simple)

merged_ftn <- pass_plays20222023 |> 
  select(play_id:air_yards, qb_hit, passer_player_id, passer_player_name, pass_defense_1_player_id,
         pass_defense_1_player_name, is_batted) |> 
  left_join(ftn_charting_clean) |> 
  select(-qb_kneel, -qb_spike) |> 
  mutate(game_date = as.Date(game_date),
         year = substr(old_game_id, 1, 4),
         season = ifelse(game_date < as.Date("2023-02-13"), 2022, 2023))
merged_ftn$is_batted <- merged_ftn$is_batted |> replace_na(0)

all_players <- nflreadr::load_players()
active_qbs <- all_players |> 
  filter(status == "ACT" & position == "QB")
qbs <- all_players |> 
  filter(position == "QB")
qb_heights <- qbs |> 
  select(passer_player_id = gsis_id, height)

merged_ftn <- merged_ftn |> 
  left_join(qb_heights, by = join_by(passer_player_id)) |>
  rename(qb_height = height)

merged_ftn2023 <- merged_ftn |> 
  filter(season == 2023) |> 
  mutate(passer_name_id = paste(passer_player_name, passer_player_id))
merged_ftn2022 <- merged_ftn |> 
  filter(season == 2022) |> 
  mutate(passer_name_id = paste(passer_player_name, passer_player_id))

pass_plays20192023 <- load_pbp(seasons = c(2019, 2020, 2021, 2022, 2023)) |> 
  filter(play_type == "pass")
pass_plays20192023 <- left_join(pass_plays20192023, excel_simple)
pass_plays20192023$is_batted <- pass_plays20192023$is_batted |> 
  replace_na(0)

full_model2023 <- glmer(is_batted ~ (1 | passer_name_id) + (1 | defteam) + qb_height +
                          pass_location + qb_location + n_offense_backfield + 
                          is_play_action + is_rpo + is_qb_out_of_pocket + n_pass_rushers,
                        family = binomial, data = merged_ftn2023)

full_model2022 <- glmer(is_batted ~ (1 | passer_name_id) + (1 | defteam) + qb_height +
                          pass_location + qb_location + n_offense_backfield + 
                          is_play_action + is_rpo + is_qb_out_of_pocket + n_pass_rushers,
                        family = binomial, data = merged_ftn2022)

tidy_coef22 <- tidy(full_model2022, effects = "ran_vals") |> 
  mutate(season = 2022)

tidy_coef23 <- tidy(full_model2023, effects = "ran_vals") |> 
  mutate(season = 2023)


tidy_model23 <- tidy(full_model2023) |> 
  filter(is.na(group)) |> 
  mutate(model = 2023) 

tidy_model22 <- tidy(full_model2022) |> 
  filter(is.na(group)) |> 
  mutate(model = 2022)

#plotting
bind_rows(tidy_coef22, tidy_coef23) |> 
  filter(group == "passer_name_id") |> 
  pivot_wider(
    id_cols = level,
    names_from = season,
    values_from = c(estimate, std.error)
  ) |> 
  mutate(gsis_id = word(level, 2),
         name = word(level, 1)) |> 
  ggplot(aes(estimate_2022, estimate_2023)) +
  #geom_nfl_headshots(aes(player_gsis = gsis_id), height = 0.2, width = 0.1, alpha = 0.5) +
  geom_point(color = "blue4") +
  ggthemes::theme_clean() +
  labs(title = "QB Coefficients for 2022 and 2023", 
       subtitle = "Higher estimates correspond to more batted passes",
       x = "2022 Estimate", y = "2023 Estimate") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed", alpha = 0.7) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", alpha = 0.7)
```


# Model Coefficient Plot {.smaller}

```{r}
#| echo: false
#| eval: true
#| message: true
#| warning: false


library(nflverse)
library(tidyverse)
library(lme4)
library(broom.mixed)
library(Matrix)
#creating dataset
player_data <- nflreadr::load_players()
all_plays2023 <- nflreadr::load_pbp()
batted_passes <- read_excel("/Users/magsb/Desktop/SURE/2019-2023_batted_passes.xlsx")
excel_batted <- batted_passes
excel_batted$is_batted <- 1
excel_simple <- excel_batted |> 
  mutate(across(c("HOME", "AWAY"), ~ str_replace(
   string = .x, pattern = "LAR", replacement = "LA"))) |> 
  select(week = WEEK, home_team = HOME, away_team = AWAY, play_id = `PLAY ID`, is_batted)

ftn_charting <- nflreadr::load_ftn_charting(seasons = c(2022, 2023))
ftn_charting_clean <- ftn_charting |> 
  select(game_id = nflverse_game_id, play_id = nflverse_play_id, 
         starting_hash:n_pass_rushers, -is_qb_sneak)
pass_plays20222023 <- load_pbp(seasons = c(2022, 2023)) |> 
  filter(play_type == "pass")
pass_plays20222023 <- left_join(pass_plays20222023, excel_simple)

merged_ftn <- pass_plays20222023 |> 
  select(play_id:air_yards, qb_hit, passer_player_id, passer_player_name, pass_defense_1_player_id,
         pass_defense_1_player_name, is_batted) |> 
  left_join(ftn_charting_clean) |> 
  select(-qb_kneel, -qb_spike) |> 
  mutate(game_date = as.Date(game_date),
         year = substr(old_game_id, 1, 4),
         season = ifelse(game_date < as.Date("2023-02-13"), 2022, 2023))
merged_ftn$is_batted <- merged_ftn$is_batted |> replace_na(0)

all_players <- nflreadr::load_players()
active_qbs <- all_players |> 
  filter(status == "ACT" & position == "QB")
qbs <- all_players |> 
  filter(position == "QB")
qb_heights <- qbs |> 
  select(passer_player_id = gsis_id, height)

merged_ftn <- merged_ftn |> 
  left_join(qb_heights, by = join_by(passer_player_id)) |>
  rename(qb_height = height)

merged_ftn2023 <- merged_ftn |> 
  filter(season == 2023) |> 
  mutate(passer_name_id = paste(passer_player_name, passer_player_id))
merged_ftn2022 <- merged_ftn |> 
  filter(season == 2022) |> 
  mutate(passer_name_id = paste(passer_player_name, passer_player_id))

pass_plays20192023 <- load_pbp(seasons = c(2019, 2020, 2021, 2022, 2023)) |> 
  filter(play_type == "pass")
pass_plays20192023 <- left_join(pass_plays20192023, excel_simple)
pass_plays20192023$is_batted <- pass_plays20192023$is_batted |> 
  replace_na(0)

full_model2023 <- glmer(is_batted ~ (1 | passer_name_id) + (1 | defteam) + qb_height +
                          pass_location + qb_location + n_offense_backfield + 
                          is_play_action + is_rpo + is_qb_out_of_pocket + n_pass_rushers,
                        family = binomial, data = merged_ftn2023)

full_model2022 <- glmer(is_batted ~ (1 | passer_name_id) + (1 | defteam) + qb_height +
                          pass_location + qb_location + n_offense_backfield + 
                          is_play_action + is_rpo + is_qb_out_of_pocket + n_pass_rushers,
                        family = binomial, data = merged_ftn2022)

tidy_coef22 <- tidy(full_model2022, effects = "ran_vals") |> 
  mutate(season = 2022)

tidy_coef23 <- tidy(full_model2023, effects = "ran_vals") |> 
  mutate(season = 2023)


tidy_model23 <- tidy(full_model2023) |> 
  filter(is.na(group)) |> 
  mutate(model = 2023) 

tidy_model22 <- tidy(full_model2022) |> 
  filter(is.na(group)) |> 
  mutate(model = 2022)

#plotting
library(broom.mixed)
#install.packages("dotwhisker")
library(dotwhisker)
tidy_model23 <- tidy(full_model2023) |> 
  filter(is.na(group)) |> 
  mutate(model = 2023) 

tidy_model22 <- tidy(full_model2022) |> 
  filter(is.na(group)) |> 
  mutate(model = 2022)

bind_rows(tidy_model23, tidy_model22) |> 
  filter(!is.na(std.error) & !is.na(estimate)) |> 
  relabel_predictors(qb_height = "QB Height", pass_locationmiddle = "Pass Middle",
                     pass_locationright = "Pass Right", qb_locationS = "Shotgun", 
                     qb_locationU = "Under Center", 
                     n_offense_backfield = "# of Players in Off. Backfield",
                     is_play_actionTRUE = "Play-Action Pass", is_rpoTRUE = "Run-Pass Option",
                     is_qb_out_of_pocketTRUE = "QB Outside of Pocket", 
                     n_pass_rushers = "# of Pass Rushers",
                     qb_locationP = "Pistol") |> 
  dwplot(ci = 0.68, vline = geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5),
         dot_args = list(size = 3), whisker_args = list(size = .6)) +
    aes(alpha = !(std.error >= abs(estimate))) +
    scale_alpha_manual(breaks = c(FALSE, TRUE), values = c(0.25, 1), guide = "none"
                       ) +
    ggthemes::scale_color_fivethirtyeight() +
    theme_bw() + 
    labs(color = "Model", alpha = "") +
  theme(legend.position = "bottom")

```

::: r-stack
Most consistent model variables: - Number of Pass Rushers - Middle Passes

QB Height has an impact in the 2023 model but not 2022
:::


# Results 3 {.smaller}

```{r}
#| echo: false
#| eval: true
#| message: true
#| warning: false
library(tidyverse)

1+1
```

# Discussion {.smaller}

-   Overall defensive characteristics determine more of the variance of batted passes
-   Create More Batted Passes?
    -   More Pass Rushers
    -   Middle Passes
-   Limit Batted Passes?
    -   Taller QBs
    -   More Offensive Backfielders
  
