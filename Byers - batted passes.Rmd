---
title: "Byers - batted passes"
output: html_document
date: "2024-06-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r read in data}
library(tidyverse)
library(readxl)
batted_passes <- read_excel("/Users/magsb/Desktop/SURE/2019-2023_batted_passes.xlsx")
batted_passes

# install.packages("nflverse")

library(nflverse)
pbp_data <- nflfastR::load_pbp()

player_data <- nflreadr::load_players()

player_data <- player_data |> 
  filter(status == "ACT")
```


```{r looking at pass location/depth}

excel_batted <- batted_passes

excel_batted$is_batted <- 1

excel_simple <- excel_batted |> 
  mutate(across(c("HOME", "AWAY"), ~ str_replace(
    string = .x, pattern = "LAR", replacement = "LA"))) |> 
  select(week = WEEK, home_team = HOME, away_team = AWAY, play_id = `PLAY ID`, is_batted)


batted_passes <- batted_passes |> 
  janitor::clean_names()

small_data <- batted_passes |> 
  select(direction, intended, togo, down, play_id, defender1, defender2, description, player)

direction_data <- small_data |> 
  group_by(direction) |> 
  summarize(direction_count = n()) |> 
  mutate(pass_location = direction) |> 
  separate(direction, sep=" ", c("depth", "direction"))


direction_data |>
  ggplot() +
  geom_col(aes(x = pass_location, y = direction_count))
```


```{r merge data - Lucca}
#all_plays2023 <- nflreadr::load_pbp()
library(readxl)


all_plays2023 <- left_join(all_plays2023, excel_simple)
all_plays2023$is_batted <- all_plays2023$is_batted |> 
  replace_na(0)
pass_plays2023 <- all_plays2023 |> 
  filter(play_type == "pass")
sum(pass_plays2023$is_batted)

#colnames(pass_plays2023)


```


```{r reconfigure data to get wanted variables}
batted_relevant <- pass_plays2023 |> 
  select(pass_length, pass_location, is_batted, passer_player_id, passer_player_name, play_id, home = home_team, away = away_team, week, year) |> 
  filter(is_batted ==1) 

batted_relevant <-
  inner_join(batted_relevant, batted_passes) |>
  separate(defender1, sep= "-", c("defender1_number", "defender1_name"))

batted_player_data <- cross_join(batted_relevant, player_data)

batted_player_data <- batted_player_data |> 
  filter(passer_player_name == short_name)

colnames(batted_player_data)

height_data <- batted_player_data |> 
  group_by(height) |> 
  summarize(batted_count = n())



height_data <- height_data |> 
  mutate(height_perc = batted_count/sum(batted_count))

height_data |>
  ggplot() +
  geom_col(aes(x = height, y = batted_count/sum(batted_count))) +
  labs(
    title = "batted passes vs quarterback height in 2022-2023 season",
    y = "percentage of total batted passes", 
    x = "quarterback height"
  )

height_data |> 
  ggplot()+
  geom_line(aes(x = height, y = height_perc), color = "red") +
  labs(
    title = "percentage of quarterback heights in 2022-2023 season",
    y = "percentage of all quarterbacks' heights" ,
    x = "quarterback height"
  )
```


```{r Yurko recommended fixes}
#create graph with two lines - one depicting total batted passes for each quarterback 
                         #   - one depicting total passes thrown for each quarterback

pass_by_qb <- left_join(pass_plays2023, player_data, by = join_by(passer_player_id == gsis_id)) 

pass_by_qb <- pass_by_qb |> 
  group_by(passer_player_name) |>   
  mutate(total_passes = n(), 
            total_batted_passes = sum(is_batted), 
            qb_height = mean(height)) |> 
  filter(total_passes>100)

pass_by_qb |> 
  ggplot() +
  geom_col(aes(x = reorder(passer_player_name, qb_height), y = total_passes)) + 
  geom_col(aes(x = reorder(passer_player_name, qb_height), y = total_batted_passes*12), color = "blue") +
  #facet_wrap(~height) + 
  scale_y_continuous(
  sec.axis = sec_axis(~. /12, name = 'total batted passes')
  ) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(
    title = "Batted Passes vs Total Passes by QB in 2023", 
    x = "QB", 
    y = "total passes thrown", 
    caption = "exlcuding QBs with less than 100 passes in the year"
  )



pass_by_qb |> 
  ggplot(aes(x = qb_height, color = factor(is_batted))) +
  geom_density() +
  theme(legend.position = "bottom") + 
  labs(
    title = "Density plot of batted and non-batted passes by QB height", 
    x = "QB Height (inches)", 
    y = "density", 
    color = "Batted"
  ) 
```



```{r column names of pass plays 2023}

colnames(pass_plays2023)

```

```{r batted passes by team}

#which teams had the most and least batted passes while on offense
offense_data <- batted_player_data |> 
  group_by(offense) |> 
  summarize(offense_batted = n())
  
offense_data |>
  ggplot() +
  geom_col(aes(x = offense, y = offense_batted))


#which team has caused the most batted passes
defense_data <- batted_player_data |> 
  group_by(defense) |> 
  summarize(defense_batted = n())

defense_data |> 
  ggplot() +
  geom_col(aes(x = defense, y = defense_batted))

```

```{r QB tendencies data setup}

 all_plays <- nflreadr::load_pbp(2020:2023)

batted_passes <- batted_passes |> 
  janitor::clean_names()

excel_batted <- batted_passes

excel_batted$is_batted <- 1
excel_simple <- excel_batted |> 
  select(week,year,  home_team = home, away_team = away, play_id, is_batted)

all_plays <- left_join(all_plays, excel_simple)
all_plays$is_batted <- all_plays$is_batted |> 
  replace_na(0)
qb_tend <- all_plays |> 
  filter(play_type == "pass")

length(qb_tend$is_batted == "1")

qb_tend$pass_LL <- paste(qb_tend$pass_length, qb_tend$pass_location, sep=" ")

```

```{r QB tendencies plotting}
library(cowplot)
sep_pass_qb <- qb_tend |> 
  group_by(passer_player_name) |> 
  filter(n()>1000) |> 
  count(pass_LL) 

sep_pass_qb |>
  ggplot(aes( x = pass_LL, y = n)) +
  geom_point() + 
  facet_wrap(~passer_player_name) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(
    title = "Pass numbers by Quarterback (2020-2023 seasons)", 
    y = "Count", 
    x = "Pass Length and Direction", 
    caption = "filtering out QBs with less than 1000 total passes"
  )

brady_pass_by_season <- qb_tend |> 
  filter(passer_player_name == "T.Brady") |> 
  group_by(season) |> 
  count(pass_LL) |> 
  ggplot(aes(x = pass_LL, y = n, color = factor(season))) +
  geom_point(alpha =.6) +   
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


brady_batted_by_season <- qb_tend |> 
  filter(passer_player_name == "T.Brady") |> 
  group_by(season, pass_LL) |> 
  count(is_batted) |> 
  filter(is_batted == 1) |> 
  ggplot(aes(x = pass_LL, y = n, color = factor(season))) + 
  geom_point(alpha = 0.6) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


plot_grid(brady_batted_by_season, brady_pass_by_season)

```

```{r QB tendencies Yurko fixes}
#Fractional deep right of total and etc, relationship of these amounts with batted passes, size = total pass attempt, each qb is a dot, x = deep left, y = batted percentage (similar thing for air yards)

#pass type by quarterback in 2023 season
qb_passes_2023 <- qb_tend |> 
  filter(season == 2023) |>
  select(passer_player_name, season, pass_LL, is_batted) |> 
  group_by(passer_player_name) |> 
  filter(n()>100) 
  
#short left  
qb_passes_2023 |> 
  group_by(passer_player_name) |> 
  mutate(total_passes = n()) |> 
  filter(pass_LL == "short left") |> 
  summarize(total = n(), 
            batted = sum(is_batted == "1")/total, 
            total_passes = mean(total_passes)) |> 
  ggplot(aes(x = total, y = batted , size = total_passes))  +
  geom_point() + 
  geom_text(aes(label = passer_player_name), 
            size = 3, 
            check_overlap = TRUE, 
            position = position_dodge(width = 1), 
            vjust = -1.5) + 
  labs(
    x = "Short Left Passes Thrown", 
    y = "Percentage of Short Left Batted", 
    title = "Short Left Passes Thrown by QB in 2023 season versus Percentage Batted", 
    size = "Total Passes in 2023 Season"

  )

#short right
qb_passes_2023 |> 
  group_by(passer_player_name) |> 
  mutate(total_passes = n()) |> 
  filter(pass_LL == "short right") |> 
  summarize(total = n(), 
            batted = sum(is_batted == "1")/total, 
            total_passes = mean(total_passes)) |> 
  ggplot(aes(x = total, y = batted , size = total_passes))  +
  geom_point() + 
  geom_text(aes(label = passer_player_name), 
            size = 3, 
            check_overlap = TRUE, 
            position = position_dodge(width = 1), 
            vjust = -1.5) + 
  labs(
    x = "Short Right Passes Thrown", 
    y = "Percentage of Short Right Batted", 
    title = "Short Right Passes Thrown by QB in 2023 season versus Percentage Batted", 
    size = "Total Passes in 2023 Season"

  )

#short middle
qb_passes_2023 |> 
  group_by(passer_player_name) |> 
  mutate(total_passes = n()) |> 
  filter(pass_LL == "short middle") |> 
  summarize(total = n(), 
            batted = sum(is_batted == "1")/total, 
            total_passes = mean(total_passes)) |> 
  ggplot(aes(x = total, y = batted , size = total_passes))  +
  geom_point() + 
  geom_text(aes(label = passer_player_name), 
            size = 3, 
            check_overlap = TRUE, 
            position = position_dodge(width = 1), 
            vjust = -1.5) + 
  labs(
    x = "Short Middle Passes Thrown", 
    y = "Percentage of Short Middle Batted", 
    title = "Short Middle Passes Thrown by QB in 2023 season versus Percentage Batted", 
    size = "Total Passes in 2023 Season"
  )

#deep middle
qb_passes_2023 |> 
  group_by(passer_player_name) |> 
  mutate(total_passes = n()) |> 
  filter(pass_LL == "deep middle") |> 
  summarize(total = n(), 
            batted = sum(is_batted == "1")/total, 
            total_passes = mean(total_passes)) |> 
  ggplot(aes(x = total, y = batted , size = total_passes))  +
  geom_point() + 
  geom_text(aes(label = passer_player_name), 
            size = 3, 
            check_overlap = TRUE, 
            position = position_dodge(width = 1), 
            vjust = -1.5) + 
  labs(
    x = "Deep Middle Passes Thrown", 
    y = "Percentage of Deep Middle Batted", 
    title = "Short Deep Passes Thrown by QB in 2023 season versus Percentage Batted", 
    size = "Total Passes in 2023 Season"
  )

#deep right
qb_passes_2023 |> 
  group_by(passer_player_name) |> 
  mutate(total_passes = n()) |> 
  filter(pass_LL == "deep right") |> 
  summarize(total = n(), 
            batted = sum(is_batted == "1")/total, 
            total_passes = mean(total_passes)) |> 
  ggplot(aes(x = total, y = batted , size = total_passes))  +
  geom_point() + 
  geom_text(aes(label = passer_player_name), 
            size = 3, 
            check_overlap = TRUE, 
            position = position_dodge(width = 1), 
            vjust = -1.5) + 
  labs(
    x = "Deep Right Passes Thrown", 
    y = "Percentage of Deep Right Batted", 
    title = "Deep Right Passes Thrown by QB in 2023 season versus Percentage Batted", 
    size = "Total Passes in 2023 Season"
  )


#deep left
qb_passes_2023 |> 
  group_by(passer_player_name) |> 
  mutate(total_passes = n()) |> 
  filter(pass_LL == "deep left") |> 
  summarize(total = n(), 
            batted = sum(is_batted == "1")/total, 
            total_passes = mean(total_passes)) |> 
  ggplot(aes(x = total, y = batted , size = total_passes))  +
  geom_point() + 
  geom_text(aes(label = passer_player_name), 
            size = 3, 
            check_overlap = TRUE, 
            position = position_dodge(width = 1), 
            vjust = -1.5) + 
  labs(
    x = "Deep Left Passes Thrown", 
    y = "Percentage of Deep Left Batted", 
    title = "Deep Left Passes Thrown by QB in 2023 season versus Percentage Batted", 
    size = "Total Passes in 2023 Season"
  )

```
```{r looking at air yards}

#Fractional deep right of total and etc, relationship of these amounts with batted passes, size = total pass attempt, each qb is a dot, x = deep left, y = batted percentage (similar thing for air yards)


#pass type by quarterback in 2023 season
qb_passes_2023_2 <- qb_tend |> 
  filter(season == 2023) |>
  select(passer_player_name, season, pass_LL, is_batted, air_yards) |> 
  group_by(passer_player_name) |> 
  filter(n()>100) 
  
#short middle  
qb_passes_2023_2 |> 
  group_by(passer_player_name) |> 
  mutate(total_passes = n()) |>   
  filter(pass_LL == "short middle") |> 
  mutate(total = n(), 
         batted = sum(is_batted == "1")/total, 
         total_passes = mean(total_passes)) |>
  ggplot(aes(x = air_yards, y = batted , size = total_passes, color = as.factor(is_batted), alpha = 0.1))  +
  geom_point() + 
  labs(
    x = "Air Yards of each Pass", 
    y = "Percentage of Short Middle Batted", 
    title = "Air Yards of Short Middle Passes in 2023 season versus Percentage Batted", 
    size = "Total Passes in 2023 Season", 
    color = "Batted"
  )

#short left  
qb_passes_2023_2 |> 
  group_by(passer_player_name) |> 
  mutate(total_passes = n()) |>   
  filter(pass_LL == "short left") |> 
  mutate(total = n(), 
         batted = sum(is_batted == "1")/total, 
         total_passes = mean(total_passes)) |>
  ggplot(aes(x = air_yards, y = batted , size = total_passes, color = as.factor(is_batted), alpha = 0.1))  +
  geom_point() + 
  labs(
    x = "Air Yards of each Pass", 
    y = "Percentage of Short Left Batted", 
    title = "Air Yards of Short Left Passes in 2023 season versus Percentage Batted", 
    size = "Total Passes in 2023 Season", 
    color = "Batted"
  )

#short right
qb_passes_2023_2 |> 
  group_by(passer_player_name) |> 
  mutate(total_passes = n()) |>   
  filter(pass_LL == "short right") |> 
  mutate(total = n(), 
         batted = sum(is_batted == "1")/total, 
         total_passes = mean(total_passes)) |>
  ggplot(aes(x = air_yards, y = batted , size = total_passes, color = as.factor(is_batted), alpha = 0.1))  +
  geom_point() + 
  labs(
    x = "Air Yards of each Pass", 
    y = "Percentage of Short Right Batted", 
    title = "Air Yards of Short Right Passes in 2023 season versus Percentage Batted", 
    size = "Total Passes in 2023 Season", 
    color = "Batted"
  )

#deep middle  
qb_passes_2023_2 |> 
  group_by(passer_player_name) |> 
  mutate(total_passes = n()) |>   
  filter(pass_LL == "deep middle") |> 
  mutate(total = n(), 
         batted = sum(is_batted == "1")/total, 
         total_passes = mean(total_passes)) |>
  ggplot(aes(x = air_yards, y = batted , size = total_passes, color = as.factor(is_batted), alpha = 0.1))  +
  geom_point() + 
  labs(
    x = "Air Yards of each Pass", 
    y = "Percentage of Deep Middle Batted", 
    title = "Air Yards of Deep Middle Passes in 2023 season versus Percentage Batted", 
    size = "Total Passes in 2023 Season", 
    color = "Batted"
  )

#deep right 
qb_passes_2023_2 |> 
  group_by(passer_player_name) |> 
  mutate(total_passes = n()) |>   
  filter(pass_LL == "deep right") |> 
  mutate(total = n(), 
         batted = sum(is_batted == "1")/total, 
         total_passes = mean(total_passes)) |>
  ggplot(aes(x = air_yards, y = batted , size = total_passes, color = as.factor(is_batted), alpha = 0.1))  +
  geom_point() + 
  labs(
    x = "Air Yards of each Pass", 
    y = "Percentage of Deep Right Batted", 
    title = "Air Yards of Deep Right Passes in 2023 season versus Percentage Batted", 
    size = "Total Passes in 2023 Season", 
    color = "Batted"
  )

#deep left  
qb_passes_2023_2 |> 
  group_by(passer_player_name) |> 
  mutate(total_passes = n()) |>   
  filter(pass_LL == "deep left") |> 
  mutate(total = n(), 
         batted = sum(is_batted == "1")/total, 
         total_passes = mean(total_passes)) |>
  ggplot(aes(x = air_yards, y = batted , size = total_passes, color = as.factor(is_batted), alpha = 0.1))  +
  geom_point() + 
  labs(
    x = "Air Yards of each Pass", 
    y = "Percentage of Deep Left Batted", 
    title = "Air Yards of Deep Left Passes in 2023 season versus Percentage Batted", 
    size = "Total Passes in 2023 Season", 
    color = "Batted"
  )
```













